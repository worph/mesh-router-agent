services:
  mesh-router-agent:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: mesh-router-agent-dev
    volumes:
      # Mount source code (parent directory)
      - ..:/app

      # Named volume for node_modules (performance on Windows/Mac)
      - node_modules:/app/node_modules

      # Named volume for pnpm store
      - pnpm-store:/pnpm/store

      # Mount entrypoint script
      - ./entrypoint-dev.sh:/entrypoint-dev.sh:ro

      # Named volume for certificate data persistence
      - agent-data:/app/data
    environment:
      - NODE_ENV=development
      # Provider connection string: <backend_url>,<userid>,<signature>
      - PROVIDER=${PROVIDER:-}
      # Public IP to register (leave empty to auto-detect)
      - PUBLIC_IP=${PUBLIC_IP:-}
      # Heartbeat interval in seconds (default: 1800 = 30 minutes)
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-1800}
    env_file:
      - path: .env
        required: false
    restart: unless-stopped

volumes:
  node_modules:
  pnpm-store:
  agent-data:
